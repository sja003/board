<h2>ğŸ›’ ì¤‘ê³ ë‚˜ë¼</h2>

<div class="card mb-4">
  <div class="card-body">
    <form method="get">
      <div class="row g-3">
        <div class="col-md-4">
          <input type="text" class="form-control" name="q" value="<%= query || '' %>" placeholder="ìƒí’ˆëª… ê²€ìƒ‰">
        </div>
        <div class="col-md-3">
          <select name="category" class="form-select">
            <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
            <% categories.forEach(category => { %>
              <option value="<%= category.id %>" <%= categoryId == category.id ? 'selected' : '' %>>
                <%= category.name %>
              </option>
            <% }) %>
          </select>
        </div>
        <div class="col-md-3">
          <select name="sort" class="form-select">
            <option value="latest" <%= sortBy === 'latest' ? 'selected' : '' %>>ìµœì‹ ìˆœ</option>
            <option value="oldest" <%= sortBy === 'oldest' ? 'selected' : '' %>>ì˜¤ë˜ëœìˆœ</option>
            <option value="price_low" <%= sortBy === 'price_low' ? 'selected' : '' %>>ë‚®ì€ê°€ê²©ìˆœ</option>
            <option value="price_high" <%= sortBy === 'price_high' ? 'selected' : '' %>>ë†’ì€ê°€ê²©ìˆœ</option>
            <option value="views" <%= sortBy === 'views' ? 'selected' : '' %>>ì¡°íšŒìˆ˜ìˆœ</option>
            <option value="likes" <%= sortBy === 'likes' ? 'selected' : '' %>>ì¢‹ì•„ìš”ìˆœ</option>
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-outline-secondary w-100">ê²€ìƒ‰</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <a href="/write" class="btn btn-primary">
      <span class="plus-circle">â•</span> ìƒí’ˆ ë“±ë¡
    </a>
    <a href="/bookmarks" class="btn btn-outline-warning">
      <span class="star">â­</span> ì°œ ëª©ë¡
    </a>
    <a href="/myposts" class="btn btn-outline-info">
      <span class="person-circle">ğŸ‘¤</span> ë‚´ ìƒí’ˆ
    </a>
  </div>
  <small class="text-muted">ì´ <%= totalPosts %>ê°œì˜ ìƒí’ˆ</small>
</div>

<% if (posts.length === 0) { %>
  <div class="text-center py-5">
    <div class="mb-4">
      <span style="font-size: 4rem;">ğŸ›’</span>
    </div>
    <h5 class="text-muted">ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</h5>
    <p class="text-muted">ì²« ë²ˆì§¸ ìƒí’ˆì„ ë“±ë¡í•´ë³´ì„¸ìš”!</p>
    <a href="/write" class="btn btn-primary">ìƒí’ˆ ë“±ë¡í•˜ê¸°</a>
  </div>
<% } else { %>
  <div class="table-responsive">
    <table class="table table-hover">
      <thead class="table-light">
        <tr>
          <th style="width: 80px;">ì´ë¯¸ì§€</th>
          <th style="width: 12%;">ì¹´í…Œê³ ë¦¬</th>
          <th style="width: 40%;">ìƒí’ˆëª…</th>
          <th style="width: 15%;">ê°€ê²©</th>
          <th style="width: 10%;">ìƒíƒœ</th>
          <th style="width: 8%;">ì¡°íšŒìˆ˜</th>
          <th style="width: 10%;">ì¢‹ì•„ìš”</th>
          <th style="width: 10%;">ì‘ì„±ì</th>
          <th style="width: 15%;">ì‘ì„±ì¼</th>
        </tr>
      </thead>
      <tbody>
        <% posts.forEach(post => { %>
          <tr class="product-row">
            <td class="align-middle">
              <% if (post.image) { %>
                <img src="/uploads/<%= post.image %>" alt="ìƒí’ˆì´ë¯¸ì§€" class="product-thumbnail">
              <% } else { %>
                <div class="no-thumbnail">
                  <span>ğŸ–¼ï¸</span>
                </div>
              <% } %>
            </td>
            <td class="align-middle">
              <span class="badge bg-secondary"><%= post.categoryName || 'ê¸°íƒ€' %></span>
            </td>
            <td class="align-middle">
              <div class="d-flex align-items-center">
                <div>
                  <a href="/post/<%= post.id %>" class="text-decoration-none fw-bold product-title">
                    <%= post.title %>
                  </a>
                  <div class="mt-1">
                    <% if (post.tradeStatus === 'sold') { %>
                      <span class="badge bg-secondary me-1">íŒë§¤ì™„ë£Œ</span>
                    <% } else if (post.tradeStatus === 'reserved') { %>
                      <span class="badge bg-warning me-1">ì˜ˆì•½ì¤‘</span>
                    <% } else { %>
                      <span class="badge bg-success me-1">íŒë§¤ì¤‘</span>
                    <% } %>
                    <% if (post.tradeLocation) { %>
                      <small class="text-muted">ğŸ“ <%= post.tradeLocation %></small>
                    <% } %>
                  </div>
                </div>
              </div>
            </td>
            <td class="align-middle">
              <div class="price-info">
                <strong class="text-primary">
                  <%= parseInt(post.price || 0).toLocaleString() %>ì›
                </strong>
              </div>
            </td>
            <td class="align-middle">
              <small class="text-muted">
                <% if (post.productCondition === 'new') { %>ìƒˆìƒí’ˆ
                <% } else if (post.productCondition === 'like_new') { %>ê±°ì˜ ìƒˆê²ƒ
                <% } else if (post.productCondition === 'used') { %>ì‚¬ìš©ê° ìˆìŒ
                <% } else if (post.productCondition === 'damaged') { %>ê³ ì¥/íŒŒì†
                <% } else { %>-<% } %>
              </small>
            </td>
            <td class="align-middle">
              <span class="badge bg-light text-dark">
                ğŸ‘ï¸ <%= post.views %>
              </span>
            </td>
            <td class="align-middle">
              <div class="d-flex gap-1">
                <span class="text-success small">ğŸ‘ <%= post.like_count %></span>
                <span class="text-danger small">ğŸ‘ <%= post.dislike_count %></span>
              </div>
            </td>
            <td class="align-middle">
              <%= post.username %>
            </td>
            <td class="align-middle date-column">
              <small><%= post.createdAt %></small>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
<% } %>

<% if (totalPages > 1) { %>
<nav aria-label="ìƒí’ˆ í˜ì´ì§€ë„¤ì´ì…˜" class="mt-4">
  <ul class="pagination justify-content-center">
    <% if (currentPage > 1) { %>
      <li class="page-item">
        <a class="page-link" href="?page=<%= currentPage - 1 %>&q=<%= query || '' %>&category=<%= categoryId %>&sort=<%= sortBy %>">ì´ì „</a>
      </li>
    <% } %>

    <% 
      let startPage = Math.max(1, currentPage - 2);
      let endPage = Math.min(totalPages, currentPage + 2);
      
      if (startPage > 1) { 
    %>
      <li class="page-item">
        <a class="page-link" href="?page=1&q=<%= query || '' %>&category=<%= categoryId %>&sort=<%= sortBy %>">1</a>
      </li>
      <% if (startPage > 2) { %>
        <li class="page-item disabled">
          <span class="page-link">...</span>
        </li>
      <% } %>
    <% } %>

    <% for (let i = startPage; i <= endPage; i++) { %>
      <li class="page-item <%= i === currentPage ? 'active' : '' %>">
        <a class="page-link" href="?page=<%= i %>&q=<%= query || '' %>&category=<%= categoryId %>&sort=<%= sortBy %>"><%= i %></a>
      </li>
    <% } %>

    <% if (endPage < totalPages) { %>
      <% if (endPage < totalPages - 1) { %>
        <li class="page-item disabled">
          <span class="page-link">...</span>
        </li>
      <% } %>
      <li class="page-item">
        <a class="page-link" href="?page=<%= totalPages %>&q=<%= query || '' %>&category=<%= categoryId %>&sort=<%= sortBy %>"><%= totalPages %></a>
      </li>
    <% } %>

    <% if (currentPage < totalPages) { %>
      <li class="page-item">
        <a class="page-link" href="?page=<%= currentPage + 1 %>&q=<%= query || '' %>&category=<%= categoryId %>&sort=<%= sortBy %>">ë‹¤ìŒ</a>
      </li>
    <% } %>
  </ul>
</nav>
<% } %>

<style>
.product-thumbnail {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 8px;
  border: 1px solid #e0e0e0;
}

.no-thumbnail {
  width: 60px;
  height: 60px;
  background-color: #f8f9fa;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
}

.product-row:hover {
  background-color: #f8f9fa;
}

.product-title {
  color: #333;
  font-size: 1rem;
}

.product-title:hover {
  color: #0d6efd !important;
}

.price-info {
  font-size: 1.1rem;
}

.badge {
  font-size: 0.75rem;
}

.table td {
  vertical-align: middle;
}

.date-column {
  white-space: nowrap;
  font-size: 0.85rem;
  min-width: 120px;
}
</style>